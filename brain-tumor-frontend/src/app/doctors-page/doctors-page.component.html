<div class="min-h-screen bg-white">

  <!-- Navbar -->
  <nav class="bg-white/95 backdrop-blur-sm border-b border-gray-100 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center space-x-3">
          <a routerLink="/" class="flex items-center space-x-3 cursor-pointer">
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg p-2">
              <lucide-icon [img]="Brain" class="h-8 w-8 text-white"></lucide-icon>
            </div>
            <span class="text-xl font-bold text-gray-900 me-0">NeuroScan AI</span>
            <span class="text-xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent ml-0 mr-1">-</span>
            <span class="text-xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent ml-0 mr-1">Doctor Portal</span>
          </a>
        </div>


        <!-- Desktop Menu -->
        <div class="flex items-center space-x-4">
          <span class="text-gray-700">Welcome, <span class="font-semibold text-blue-600">{{ username }}</span></span>
          <div class="relative" #userMenuContainer>
            <button
              (click)="toggleUserMenu()"
              class="flex items-center space-x-2 text-gray-700 hover:text-blue-600 transition p-2 rounded-lg hover:bg-gray-50">
              <div class="w-8 h-8 bg-gradient-to-r from-blue-600 to-purple-600 rounded-full flex items-center justify-center">
                <span class="text-white text-sm font-semibold">{{ getUserInitials() }}</span>
              </div>
              <lucide-icon [img]="ChevronDown" class="w-4 h-4"></lucide-icon>
            </button>

            <!-- User dropdown menu -->
            <div *ngIf="isUserMenuOpen" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-100 py-1 z-50">
              <a href="/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition">
                <lucide-icon [img]="User" class="w-4 h-4 inline mr-2"></lucide-icon>
                Profile
              </a>
              <a href="/dashboard" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition">
                <lucide-icon [img]="LayoutDashboard" class="w-4 h-4 inline mr-2"></lucide-icon>
                Dashboard
              </a>
              <a href="/settings" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition">
                <lucide-icon [img]="Settings" class="w-4 h-4 inline mr-2"></lucide-icon>
                Settings
              </a>
              <hr class="my-1">
              <button
                (click)="logout()"
                class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition">
                <lucide-icon [img]="LogOut" class="w-4 h-4 inline mr-2"></lucide-icon>
                Sign Out
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8 flex justify-between items-center">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Patient Results</h1>
        <p class="text-gray-600">Review and manage your patient scan results</p>
      </div>

      <div>
        <button routerLink="/report" class="flex gap-1 bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-2 rounded-lg hover:shadow-lg transition transform hover:-translate-y-0.5">
          <lucide-icon [img]="FileText"></lucide-icon>
          Create AI report
        </button>
      </div>
    </div>

    <!-- Search Bar -->
    <div class="mb-6">
      <div class="relative max-w-md">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <lucide-icon [img]="Search" class="h-5 w-5 text-gray-400"></lucide-icon>
        </div>
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (input)="onSearchChange()"
          placeholder="Search by EMBG, name, or email..."
          class="block w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
        <div *ngIf="searchTerm" class="absolute inset-y-0 right-0 pr-3 flex items-center">
          <button
            (click)="clearSearch()"
            class="text-gray-400 hover:text-gray-600 transition-colors">
            <lucide-icon [img]="X" class="h-4 w-4"></lucide-icon>
          </button>
        </div>
      </div>
      <div *ngIf="searchTerm" class="mt-2 text-sm text-gray-600">
        Showing {{ filteredResults.length }} of {{ results.length }} results for "{{ searchTerm }}"
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="flex justify-center items-center py-12">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      <span class="ml-3 text-gray-600">Loading results...</span>
    </div>

    <!-- Results Table -->
    <div *ngIf="!loading" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
      <!-- Table Header -->
      <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-gray-900">Recent Scans</h2>
          <div class="flex items-center space-x-2">
            <span class="text-sm text-gray-500">
              {{ searchTerm ? 'Filtered Results:' : 'Total Results:' }}
            </span>
            <span class="bg-blue-100 text-blue-800 text-sm font-medium px-2.5 py-0.5 rounded-full">
              {{ searchTerm ? filteredResults.length : results.length }}
            </span>
          </div>
        </div>
      </div>

      <!-- Table Content -->
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Classification</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Confidence</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Model</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Embg</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
          <tr *ngFor="let result of filteredResults" [ngClass]="{
                'hover:bg-gray-50 transition-colors': result.classification !== 'NONE',
                'bg-red-25 hover:bg-red-100': result.classification === 'NONE'
              }">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-10 w-10">
                  <div class="h-10 w-10 rounded-full bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center">
                      <span class="text-sm font-medium text-white">
                        {{ (result.patient.name.charAt(0) + result.patient.surname.charAt(0)).toUpperCase() }}
                      </span>
                  </div>
                </div>
                <div class="ml-4">
                  <div class="text-sm font-medium text-gray-900">{{ result.patient.name }} {{ result.patient.surname }}</div>
                  <div class="text-sm text-gray-500">{{ result.patient.email }}</div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">{{ result.date }}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span [ngClass]="{
                'bg-yellow-100 text-yellow-800': result.classification.toLowerCase().includes('none'),
                  'bg-red-100 text-red-800': result.classification.toLowerCase().includes('tumor'),
                  'bg-green-100 text-green-800': !result.classification.toLowerCase().includes('tumor')
                }" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                  <span [ngClass]="{
                  'bg-yellow-500 text-yellow-800': result.classification.toLowerCase().includes('none'),
                    'bg-red-500': result.classification.toLowerCase().includes('tumor'),
                    'bg-green-500': !result.classification.toLowerCase().includes('tumor')
                  }" class="w-2 h-2 rounded-full mr-1.5"></span>
                  {{ result.classification == "NONE" ? "/" : result.classification}}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="flex-1 bg-gray-200 rounded-full h-2 mr-3">
                  <div class="bg-gradient-to-r from-blue-600 to-purple-600 h-2 rounded-full" [style.width.%]="result.confidence * 100"></div>
                </div>
                <span class="text-sm font-medium text-gray-900">{{ (result.confidence * 100) | number:'1.0-1' }}%</span>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              {{ result.modelUsed == "NONE" ? "/" : result.modelUsed }}
            </td>
            <td class="px-6 py-4">
              <div class="text-sm text-gray-900 max-w-xs truncate" [title]="result.patient.embg">
                {{ result.patient.embg || 'embg' }}
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <div class="flex space-x-2">
                <button class="text-green-600 hover:text-green-900 transition-colors" title="Edit Notes">
                  <lucide-icon [img]="icons.Edit" class="w-4 h-4"></lucide-icon>
                </button>
                <app-pdf-generator [result]="result"></app-pdf-generator>
              </div>
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <!-- Empty State -->
      <div *ngIf="filteredResults.length === 0 && !loading" class="text-center py-12">
        <lucide-icon [img]="FileText" class="mx-auto h-12 w-12 text-gray-400"></lucide-icon>
        <h3 class="mt-2 text-sm font-medium text-gray-900">
          {{ searchTerm ? 'No matching results found' : 'No results found' }}
        </h3>
        <p class="mt-1 text-sm text-gray-500">
          {{ searchTerm ? 'Try adjusting your search criteria.' : 'No patient scan results are available at this time.' }}
        </p>
        <button *ngIf="searchTerm"
                (click)="clearSearch()"
                class="mt-4 text-blue-600 hover:text-blue-800 text-sm font-medium">
          Clear search
        </button>
      </div>
    </div>
  </div>
</div>
